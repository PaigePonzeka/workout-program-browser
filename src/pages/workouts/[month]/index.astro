---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { getUrl } from "@/utils/url";

interface Props {
  month: string;
  monthSlug: string;
  entryId: string;
}

export async function getStaticPaths() {
  const allWorkouts = await getCollection("workouts");
  
  // Group by month
  const months = allWorkouts.reduce((acc, entry) => {
    const parts = entry.id.split('/');
    const slug = parts[0] === 'workouts' ? parts[1] : parts[0];
    if (!acc[slug]) {
      acc[slug] = [];
    }
    acc[slug].push(entry);
    return acc;
  }, {} as Record<string, any[]>);

  return Object.entries(months).map(([slug, entries]) => {
    const monthEntry = entries.find(e => e.id.endsWith('index.md'));
    if (!monthEntry) return null;
    
    return {
      params: { month: slug },
      props: { 
        monthSlug: slug,
        entryId: monthEntry.id
      } as Props
    };
  }).filter(Boolean);
}

const { monthSlug, entryId } = Astro.props as Props;
const allWorkouts = await getCollection("workouts");

// Find the month entry by its exact ID
const monthEntry = allWorkouts.find(entry => entry.id === entryId);

if (!monthEntry) {
  return Astro.redirect("/404");
}

// Get all month entries for navigation
const monthEntries = (await getCollection("workouts"))
  .filter(entry => entry.id.endsWith('index.md'))
  .sort((a, b) => a.id.localeCompare(b.id));

const currentIndex = monthEntries.findIndex(entry => entry.id === entryId);
const prevMonth = monthEntries[currentIndex - 1];
const nextMonth = monthEntries[currentIndex + 1];

// Get day entries for this month
const days = allWorkouts
  .filter(entry => {
    const dayPattern = new RegExp(`(^|/)${monthSlug}/day(\\d+)\\.md$`);
    return dayPattern.test(entry.id);
  })
  .sort((a, b) => {
    const getDayNumber = (id: string) => parseInt(id.match(/day(\d+)\.md$/)?.[1] || '0', 10);
    return getDayNumber(a.id) - getDayNumber(b.id);
  });

const { Content } = await monthEntry.render();

const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: "Workouts", href: "/workouts" },
  { label: monthSlug },
];
---

<BaseLayout
  title={`${monthEntry.data.title} - ${monthSlug}`}
  description={monthEntry.data.goal || `Workout program for ${monthSlug}`}
  breadcrumbs={breadcrumbs}
>
  <!-- Month Navigation -->
  <div class="bg-base-200 py-2">
    <div class="max-w-5xl mx-auto px-4 lg:px-8 flex justify-between items-center">
      {prevMonth ? (
        <a 
          href={getUrl(`workouts/${prevMonth.slug}`)} 
          class="flex items-center gap-2 text-sm hover:text-primary transition-colors"
        >
          ← {prevMonth.slug}
        </a>
      ) : <div></div>}
      
      <span class="font-medium">{monthSlug}</span>
      
      {nextMonth ? (
        <a 
          href={getUrl(`workouts/${nextMonth.slug}`)}
          class="flex items-center gap-2 text-sm hover:text-primary transition-colors"
        >
          {nextMonth.slug} →
        </a>
      ) : <div></div>}
    </div>
  </div>

  <!-- Month Header -->
  <section class="relative overflow-hidden bg-base-100">
    <div class="relative max-w-5xl mx-auto px-4 lg:px-8 py-12">
      <div class="text-center max-w-3xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          {monthEntry.data.title}
        </h1>
        {monthEntry.data.goal && (
          <p class="text-lg text-base-content/70 max-w-2xl mx-auto">
            {monthEntry.data.goal}
          </p>
        )}
      </div>
    </div>
  </section>

  <div class="max-w-5xl mx-auto px-4 lg:px-8 pb-16">
    <!-- Program Content -->
    <section class="prose prose-lg max-w-3xl mx-auto mb-12">
      <Content />
    </section>

    <!-- Workout Days -->
    {days.length > 0 && (
      <section class="mb-12">
        <h2 class="text-2xl font-bold mb-6 text-center">
          Workout Days
        </h2>
        <div class="grid gap-6 md:grid-cols-2">
          {days.map((day) => {
            const dayNumber = day.id.match(/day(\d+)\.md$/)?.[1] || '0';
            const dayTitle = day.data.title || `Day ${dayNumber}`;
            
            return (
              <a 
                href={getUrl(`workouts/${monthSlug}/day${dayNumber}`)}
                class="group block bg-base-100 rounded-xl border border-base-300 overflow-hidden hover:border-primary/50 hover:shadow-lg transition-all duration-300"
              >
                <div class="p-6">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold">
                      {dayNumber}
                    </div>
                    <h3 class="text-xl font-bold group-hover:text-primary transition-colors">
                      {dayTitle}
                    </h3>
                  </div>
                  
                  {day.data.focus && (
                    <p class="text-base-content/70 mb-4">
                      {day.data.focus}
                    </p>
                  )}
                  
                  <div class="flex flex-wrap gap-2 mt-4">
                    {day.data.difficulty && (
                      <span class="badge badge-sm">
                        {day.data.difficulty}
                      </span>
                    )}
                    {day.data.duration && (
                      <span class="badge badge-sm badge-ghost">
                        {day.data.duration}
                      </span>
                    )}
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}
  </div>
</BaseLayout>
