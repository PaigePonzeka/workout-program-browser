---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { getUrl } from "@/utils/url";

interface Props {
  month: string;
  monthSlug: string;
  entryId: string;
}

export async function getStaticPaths() {
  const allWorkouts = await getCollection("workouts");

  // Group by month
  const months = allWorkouts.reduce((acc, entry) => {
    const parts = entry.id.split('/');
    const slug = parts[0] === 'workouts' ? parts[1] : parts[0];
    if (!acc[slug]) acc[slug] = [];
    acc[slug].push(entry);
    return acc;
  }, {} as Record<string, any[]>);

  return Object.entries(months).map(([slug, entries]) => {
    const monthEntry = entries.find(e => e.id.endsWith('index.md'));
    if (!monthEntry) return null;
    return {
      params: { month: slug },
      props: { monthSlug: slug, entryId: monthEntry.id } as Props,
    };
  }).filter(Boolean);
}

const { monthSlug, entryId } = Astro.props as Props;
const allWorkouts = await getCollection("workouts");

// Find the month entry by its exact ID
const monthEntry = allWorkouts.find(entry => entry.id === entryId);
if (!monthEntry) return Astro.redirect("/404");

// Get all month index entries for prev/next navigation, sorted by slug ascending
const monthEntries = allWorkouts
  .filter(entry => entry.id.endsWith('index.md'))
  .sort((a, b) => a.id.localeCompare(b.id));

// Helper: extract the month folder slug from an entry ID (works with or without leading "workouts/")
const slugFromEntry = (entry: (typeof allWorkouts)[number]) => {
  const parts = entry.id.split('/');
  return parts[0] === 'workouts' ? parts[1] : parts[0];
};

const currentIndex = monthEntries.findIndex(entry => entry.id === entryId);
const prevMonth = currentIndex > 0 ? monthEntries[currentIndex - 1] : null;
const nextMonth = currentIndex < monthEntries.length - 1 ? monthEntries[currentIndex + 1] : null;

// Get day entries for this month, sorted by day number
const days = allWorkouts
  .filter(entry => {
    const dayPattern = new RegExp(`(^|/)${monthSlug}/day(\\d+)\\.md$`);
    return dayPattern.test(entry.id);
  })
  .sort((a, b) => {
    const n = (id: string) => parseInt(id.match(/day(\d+)\.md$/)?.[1] || '0', 10);
    return n(a.id) - n(b.id);
  });

const { Content } = await monthEntry.render();

const monthTitle = monthEntry.data.title || monthSlug;
const monthHref = `/workouts/${monthSlug}`;

const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: monthTitle },
];

const siteBase = Astro.site
  ? new URL(import.meta.env.BASE_URL || "/", Astro.site).href.replace(/\/$/, "")
  : "";

// Derive publication date from the month slug (e.g. "2026-02" → "2026-02-01")
const datePublished = `${monthSlug}-01`;

// Keyword-rich meta description for SEO and AIO
const pageDescription = `${monthTitle} — a free ${days.length}-session functional fitness program from FORGED. Built on progressive overload and periodization with Push, Pull, Full Body, and Engine workouts. 45–60 minutes per session.`;

// Primary schema: Course with hasPart listing each day as a minimal ExercisePlan
// This is the most semantically accurate schema for a structured multi-session program
const courseSchema = {
  "@context": "https://schema.org",
  "@type": "Course",
  name: monthTitle,
  description: pageDescription,
  url: `${siteBase}/workouts/${monthSlug}/`,
  provider: {
    "@type": "Organization",
    name: "FORGED",
    url: `${siteBase}/`,
  },
  datePublished,
  educationalLevel: "Intermediate",
  isAccessibleForFree: true,
  hasPart: days.map(day => {
    const dayNum = day.id.match(/day(\d+)\.md$/)?.[1] || '0';
    const displayNum = parseInt(dayNum, 10) + 1;
    return {
      "@type": "ExercisePlan",
      name: day.data.title || `Day ${displayNum}`,
      url: `${siteBase}/workouts/${monthSlug}/day${dayNum}/`,
      activityDuration: {
        "@type": "QuantitativeValue",
        minValue: 45,
        maxValue: 60,
        unitCode: "MIN",
      },
      exerciseType: "Functional Fitness",
      isPartOf: {
        "@type": "Course",
        name: monthTitle,
        url: `${siteBase}/workouts/${monthSlug}/`,
      },
    };
  }),
};

// Secondary schema: Article — improves AIO pickup by generative search engines
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: `${monthTitle} — Free ${days.length}-Session Workout Program`,
  description: pageDescription,
  url: `${siteBase}/workouts/${monthSlug}/`,
  datePublished,
  publisher: {
    "@type": "Organization",
    name: "FORGED",
    url: `${siteBase}/`,
  },
};
---

<BaseLayout
  title={`${monthTitle} — Free ${days.length}-Session Workout Program`}
  description={pageDescription}
  breadcrumbs={breadcrumbs}
  schema={[courseSchema, articleSchema]}
>

  <!-- Month Navigation -->
  <div class="bg-base-200 border-b border-base-300">
    <div class="max-w-5xl mx-auto px-4 lg:px-8 py-2 flex justify-between items-center">
      {prevMonth ? (
        <a
          href={getUrl(`workouts/${slugFromEntry(prevMonth)}`)}
          class="inline-flex items-center gap-1.5 text-sm text-base-content/50 hover:text-primary transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
          {prevMonth.data.title || slugFromEntry(prevMonth)}
        </a>
      ) : <div />}

      <span class="text-sm font-medium text-base-content/40">{monthSlug}</span>

      {nextMonth ? (
        <a
          href={getUrl(`workouts/${slugFromEntry(nextMonth)}`)}
          class="inline-flex items-center gap-1.5 text-sm text-base-content/50 hover:text-primary transition-colors"
        >
          {nextMonth.data.title || slugFromEntry(nextMonth)}
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
        </a>
      ) : <div />}
    </div>
  </div>

  <!-- Month Header -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-base-100 to-accent/5 pointer-events-none"></div>
    <div class="relative max-w-5xl mx-auto px-4 lg:px-8 py-12 sm:py-16 text-center">
      <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-4" style="font-family: 'Outfit', sans-serif;">
        {monthTitle}
      </h1>

      <!-- Program metadata strip -->
      <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-base-content/50 mb-6">
        <span class="inline-flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          {days.length} workouts
        </span>
        <span class="inline-flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          4-week program
        </span>
        <span class="inline-flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          45–60 min / session
        </span>
        <span class="inline-flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
          Progressive overload
        </span>
        <span class="inline-flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Free
        </span>
      </div>

      {days.length > 0 && (
        <a href="#workouts" class="btn btn-primary btn-sm gap-2">
          View Workouts
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </a>
      )}
    </div>
  </section>

  <div class="max-w-5xl mx-auto px-4 lg:px-8 pb-16">

    <!-- Program Overview -->
    <section class="prose prose-base max-w-3xl mx-auto mb-12">
      <Content />
    </section>

    <!-- Workout Days -->
    {days.length > 0 && (
      <section id="workouts" class="mb-12">
        <h2 class="text-2xl font-bold mb-2 text-center" style="font-family: 'Outfit', sans-serif;">
          Workout Sessions
        </h2>
        <p class="text-sm text-base-content/50 text-center mb-8">
          Push · Pull · Full Body · Engine — pick a day and go
        </p>

        <div class="grid gap-4 sm:grid-cols-2">
          {days.map((day) => {
            const dayNum = day.id.match(/day(\d+)\.md$/)?.[1] || '0';
            const displayNum = parseInt(dayNum, 10) + 1;
            const dayTitle = day.data.title || `Day ${displayNum}`;
            return (
              <a
                href={getUrl(`workouts/${monthSlug}/day${dayNum}`)}
                class="group block bg-base-100 rounded-xl border border-base-300 overflow-hidden hover:border-primary/50 hover:shadow-md transition-all duration-200"
              >
                <div class="p-5">
                  <div class="flex items-center gap-3 mb-3">
                    <div class="w-9 h-9 rounded-full bg-primary/10 text-primary flex items-center justify-center font-bold text-sm shrink-0">
                      {displayNum}
                    </div>
                    <h3 class="font-semibold group-hover:text-primary transition-colors leading-snug" style="font-family: 'Outfit', sans-serif;">
                      {dayTitle}
                    </h3>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <span class="badge badge-ghost badge-sm">45–60 min</span>
                    <span class="badge badge-ghost badge-sm">Functional Fitness</span>
                  </div>
                </div>
              </a>
            );
          })}
        </div>
      </section>
    )}

  </div>
</BaseLayout>
