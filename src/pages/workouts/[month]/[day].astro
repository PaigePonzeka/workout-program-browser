---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allWorkouts = await getCollection("workouts");
  const dayEntries = [];

  // Process each day entry
  for (const entry of allWorkouts) {
    // Skip non-day entries (should be in format '2024-06/day1.md')
    if (!entry.id.match(/\/day\d+\.md$/)) continue;

    // Extract month and day info from the entry ID
    const parts = entry.id.split('/');
    const monthSlug = parts[0] === 'workouts' ? parts[1] : parts[0];
    const dayMatch = entry.id.match(/day(\d+)\.md$/);
    
    if (!dayMatch) continue;
    
    const dayNumber = parseInt(dayMatch[1], 10);
    const daySlug = `day${dayNumber}`;

    // Find the corresponding month entry (should be in the same directory)
    const monthEntry = allWorkouts.find(e => 
      e.id.endsWith(`${monthSlug}/index.md`)
    );

    if (!monthEntry) {
      console.warn(`No month entry found for day: ${entry.id}`);
      continue;
    }

    dayEntries.push({
      params: {
        month: monthSlug,
        day: daySlug,
      },
      props: { 
        entryId: entry.id,
        monthSlug,
        dayNumber
      },
    });
  }

  return dayEntries;
}

const { entryId, monthSlug, dayNumber } = Astro.props as {
  entryId: string;
  monthSlug: string;
  dayNumber: number;
};

const allWorkouts = await getCollection("workouts");

// Find the day entry by its exact ID
const entry = allWorkouts.find(e => e.id === entryId);
if (!entry) {
  return Astro.redirect("/404");
}

// Find the month entry
const monthEntry = allWorkouts.find(e => 
  e.id.endsWith(`${monthSlug}/index.md`)
);

if (!monthEntry) {
  return Astro.redirect("/404");
}

// Get all days for this month for navigation
const monthDays = allWorkouts
  .filter(e => {
    const dayMatch = e.id.match(/day(\d+)\.md$/);
    return dayMatch && e.id.includes(monthSlug);
  })
  .sort((a, b) => {
    const aDay = parseInt(a.id.match(/day(\d+)\.md$/)?.[1] || '0', 10);
    const bDay = parseInt(b.id.match(/day(\d+)\.md$/)?.[1] || '0', 10);
    return aDay - bDay;
  });

const currentIndex = monthDays.findIndex(e => e.id === entryId);
const prevDay = currentIndex > 0 ? monthDays[currentIndex - 1] : null;
const nextDay = currentIndex < monthDays.length - 1 ? monthDays[currentIndex + 1] : null;

// Render content
const { Content } = await entry.render();

const monthTitle = monthEntry.data.title || monthSlug;
const monthHref = `/workouts/${monthSlug}`;

const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: "Workouts", href: "/workouts" },
  { label: monthSlug, href: monthHref },
  { label: `Day ${dayNumber}` },
];
---

<BaseLayout
  title={`${entry.data.title} - ${monthTitle}`}
  description={entry.data.focus || `Day ${dayNumber} of ${monthTitle} workout program`}
  breadcrumbs={breadcrumbs}
  class="bg-base-100"
>
  <div class="max-w-3xl mx-auto px-4 lg:px-8 py-8 sm:py-10">
    <!-- Day Header -->
    <header class="mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
        <div>
          <a href={monthHref} class="inline-flex items-center text-sm text-primary hover:underline mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to {monthTitle}
          </a>
          <h1 class="text-3xl font-bold tracking-tight">
            {entry.data.title}
          </h1>
        </div>

        <div class="flex items-center gap-3">
          <span class="badge badge-primary">Day {dayNumber}</span>
        </div>
      </div>

      <!-- Navigation -->
      <div class="border-t border-base-300 pt-6">
        <div class="flex justify-between items-center">
          {prevDay ? (
            <a 
              href={`/workouts/${monthSlug}/day${prevDay.id.match(/day(\d+)\.md$/)?.[1] || ''}`}
              class="btn btn-ghost btn-sm"
            >
              ← Previous
            </a>
          ) : <div></div>}
          
          {nextDay && (
            <a 
              href={`/workouts/${monthSlug}/day${nextDay.id.match(/day(\d+)\.md$/)?.[1] || ''}`}
              class="btn btn-ghost btn-sm"
            >
              Next →
            </a>
          )}
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="prose prose-sm sm:prose-base max-w-none">
      <Content />
    </main>

    <!-- More Workouts -->
    {monthDays.length > 1 && (
      <div class="mt-16 pt-8 border-t border-base-300">
        <h2 class="text-xl font-semibold mb-6">More Workouts in {monthTitle}</h2>
        <div class="grid gap-4 sm:grid-cols-2">
          {monthDays
            .filter(day => day.id !== entryId)
            .slice(0, 4)
            .map(day => {
              const dayNum = day.id.match(/day(\d+)\.md$/)?.[1] || '0';
              return (
                <a 
                  href={`/workouts/${monthSlug}/day${dayNum}`}
                  class="block p-4 rounded-lg border border-base-300 hover:border-primary/50 hover:shadow transition-all"
                >
                  <h3 class="font-medium">{day.data.title || `Day ${dayNum}`}</h3>
                  {day.data.focus && (
                    <p class="text-sm text-base-content/60 mt-1 line-clamp-2">
                      {day.data.focus}
                    </p>
                  )}
                </a>
              );
            })}
        </div>
      </div>
    )}
  </div>
</BaseLayout>

      } : undefined}
      monthHref={monthHref}
      monthTitle={monthTitle}
    />

  </div>

</BaseLayout>
