---
import BaseLayout from "@/layouts/BaseLayout.astro";
import DayNav from "@/components/DayNav.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import ExerciseGroup from "@/components/ExerciseGroup.astro";
import ExerciseCard from "@/components/ExerciseCard.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allWorkouts = await getCollection("workouts");
  const dayEntries = [];

  // Process each day entry
  for (const entry of allWorkouts) {
    if (entry.data.type !== "day") continue;

    // Extract month slug from the entry ID
    // Handle both '2026-02/day1.md' and 'workouts/2026-02/day1.md' formats
    const parts = entry.id.split('/');
    const monthSlug = parts[0] === 'workouts' ? parts[1] : parts[0];
    const dayNumber = entry.data.dayNumber;
    
    if (!dayNumber) {
      console.warn(`Day entry ${entry.id} is missing dayNumber`);
      continue;
    }

    // Find the corresponding month entry
    const monthEntry = allWorkouts.find(e => 
      e.data.type === 'month' && 
      (e.id.startsWith(monthSlug) || e.id.endsWith(monthSlug))
    );

    if (!monthEntry) {
      console.warn(`No month entry found for day: ${entry.id}`);
      continue;
    }

    dayEntries.push({
      params: {
        month: monthSlug,
        day: `day${dayNumber}`,
      },
      props: { 
        entryId: entry.id,
        monthSlug,
        monthEntryId: monthEntry.id
      },
    });
  }

  return dayEntries;
}

const { entryId, monthSlug, monthEntryId } = Astro.props;
const allWorkouts = await getCollection("workouts");

// Find the day entry by its exact ID
const entry = allWorkouts.find(e => e.id === entryId);
if (!entry) {
  console.error(`Day entry not found: ${entryId}`);
  return Astro.redirect("/404");
}

// Find the month entry by its exact ID
const monthEntry = allWorkouts.find(e => e.id === monthEntryId);
if (!monthEntry) {
  console.error(`Month entry not found for day: ${entryId}`);
  return Astro.redirect("/404");
}

// Get all days for this month for navigation
const monthDays = allWorkouts
  .filter(e => 
    e.data.type === 'day' && 
    e.id.startsWith(monthSlug)
  )
  .sort((a, b) => (a.data.dayNumber || 0) - (b.data.dayNumber || 0));

const currentIndex = monthDays.findIndex(e => e.id === entryId);
const prevDay = currentIndex > 0 ? monthDays[currentIndex - 1] : null;
const nextDay = currentIndex < monthDays.length - 1 ? monthDays[currentIndex + 1] : null;

// Render content
const { Content, headings } = await entry.render();

const monthTitle = monthEntry.data.month || monthSlug;
const monthHref = `/workouts/${monthSlug}`;

const breadcrumbs = [
  { label: "Home", href: "/" },
  { label: monthTitle, href: monthHref },
  { label: `Day ${entry.data.dayNumber}` },
];

const difficultyColors: Record<string, string> = {
  beginner: "badge-success",
  intermediate: "badge-warning",
  advanced: "badge-error",
};
---

<BaseLayout
  title={`Day ${entry.data.dayNumber}: ${entry.data.title}`}
  description={entry.data.focus || entry.data.title}
  breadcrumbs={breadcrumbs}
>

  <div class="max-w-3xl mx-auto px-4 lg:px-8 py-8 sm:py-10">

    <!-- ─── Day Header ─── -->
    <header class="mb-6">
      <div class="flex items-center gap-3 mb-3">
        <div class="w-12 h-12 rounded-xl bg-primary text-primary-content font-bold text-lg flex items-center justify-center" style="font-family: 'Outfit', sans-serif;">
          {entry.data.dayNumber}
        </div>
        <div>
          <p class="text-xs text-base-content/40 uppercase tracking-widest font-medium">
            Day {entry.data.dayNumber}
          </p>
          <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight" style="font-family: 'Outfit', sans-serif;">
            {entry.data.title}
          </h1>
        </div>
      </div>

      {/* Meta badges */}
      <div class="flex flex-wrap gap-2 mt-4">
        {entry.data.focus && (
          <span class="badge badge-primary badge-outline badge-sm">{entry.data.focus}</span>
        )}
        {entry.data.duration && (
          <span class="badge badge-ghost badge-sm gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            {entry.data.duration}
          </span>
        )}
        {entry.data.difficulty && (
          <span class={`badge badge-sm badge-outline ${difficultyColors[entry.data.difficulty] || ""}`}>
            {entry.data.difficulty}
          </span>
        )}
      </div>

      {/* Equipment list */}
      {entry.data.equipment && entry.data.equipment.length > 0 && (
        <div class="mt-4 p-3 bg-base-200 rounded-xl border border-base-300">
          <p class="text-xs text-base-content/40 uppercase tracking-widest font-medium mb-1.5">Equipment Needed</p>
          <div class="flex flex-wrap gap-1.5">
            {entry.data.equipment.map((item) => (
              <span class="badge badge-sm badge-ghost">{item}</span>
            ))}
          </div>
        </div>
      )}
    </header>

    <!-- ─── Table of Contents ─── -->
    <TableOfContents headings={headings} />

    <!-- ─── Workout Content ─── -->
    <div class="space-y-8">
      <ExerciseGroup title="Warm-Up">
        <div class="space-y-4">
          <ExerciseCard 
            name="Band Pull-Aparts"
            sets={2}
            reps="15"
            rest="30 sec"
            rpe={4}
            cues={["Keep shoulders down and back", "Squeeze shoulder blades together"]}
          />
          
          <ExerciseCard 
            name="Arm Circles"
            sets={1}
            reps="30 sec"
            rest="30 sec"
            rpe={3}
            cues={["Forward and backward", "Keep core engaged"]}
          />
        </div>
      </ExerciseGroup>

      <ExerciseGroup title="Main Work">
        <div class="space-y-6">
          <ExerciseCard 
            variant="A"
            name="Incline Barbell Bench Press"
            sets={4}
            reps="6-8"
            rest="2-3 min"
            rpe={8}
            cues={["45° bench angle", "Bar to upper chest", "Squeeze at the top"]}
          />

          <ExerciseCard 
            variant="B"
            name="Dumbbell Shoulder Press"
            sets={3}
            reps="8-10"
            rest="90 sec"
            rpe={7}
            cues={["Elbows slightly forward", "Press overhead with control"]}
          />
        </div>
      </ExerciseGroup>

      <ExerciseGroup title="Accessory Work">
        <div class="space-y-6">
          <ExerciseCard 
            variant="C1"
            name="Incline Dumbbell Fly"
            sets={3}
            reps="12-15"
            rest="60 sec"
            rpe={8}
            cues={["Slight bend in elbows", "Control the stretch"]}
          />

          <ExerciseCard 
            variant="C2"
            name="Lateral Raises"
            sets={3}
            reps="15-20"
            rest="45 sec"
            rpe={8}
            cues={["Slight bend in elbows", "Raise to shoulder height"]}
          />
        </div>
      </ExerciseGroup>
    </div>

    <!-- ─── Prev/Next Navigation ─── -->
    <DayNav
      prev={prevDay ? {
        dayNumber: prevDay.data.dayNumber!,
        title: prevDay.data.title,
        href: `/workouts/${monthSlug}/day${prevDay.data.dayNumber}`,
      } : undefined}
      next={nextDay ? {
        dayNumber: nextDay.data.dayNumber!,
        title: nextDay.data.title,
        href: `/workouts/${monthSlug}/day${nextDay.data.dayNumber}`,
      } : undefined}
      monthHref={monthHref}
      monthTitle={monthTitle}
    />

  </div>

</BaseLayout>
